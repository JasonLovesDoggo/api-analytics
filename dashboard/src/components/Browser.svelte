<script lang="ts">
  import { onMount } from "svelte";

  function getBrowser(userAgent: string): string {
    if (userAgent.match(/Seamonkey\//)) {
        return 'Seamonkey'
    } else if (userAgent.match(/Firefox\//)) {
        return 'Firefox'
    } else if (userAgent.match(/Chrome\//)) {
        return 'Chrome'
    } else if (userAgent.match(/Chromium\//)) {
        return 'Chromium'
    } else if (userAgent.match(/Safari\//)) {
        return 'Safari'
    } else if (userAgent.match(/Edg\//)) {
        return 'Edge'
    } else if (userAgent.match(/OPR\//) || userAgent.match(/Opera\//)) {
        return 'Opera'
    } else if (userAgent.match(/; MSIE /) || userAgent.match(/Trident\//)) {
        return 'Internet Explorer'
    } else if (userAgent.match(/curl\//)) {
        return 'Curl'
    } else if (userAgent.match(/PostmanRuntime\//)) {
        return 'Postman'
    } else if (userAgent.match(/insomnia\//)) {
        return 'Insomnia'
    } else {
        return 'Other'
    }
  }

  function browserPlotLayout() {
    let monthAgo = new Date();
    monthAgo.setDate(monthAgo.getDate() - 30);
    let tomorrow = new Date();
    tomorrow.setDate(tomorrow.getDate() + 1);
    return {
      title: false,
      autosize: true,
      margin: { r: 35, l: 70, t: 20, b: 20, pad: 0 },
      hovermode: "closest",
      plot_bgcolor: "transparent",
      paper_bgcolor: "transparent",
      height: 180,
      yaxis: {
        title: { text: "Requests" },
        gridcolor: "gray",
        showgrid: false,
        fixedrange: true,
      },
      xaxis: {
        visible: false,
      },
      dragmode: false,
    };
  }

  let colors = [
    "#3FCF8E",  // Green
    "#5784BA",  // Blue
    "#EBEB81",  // Yellow
    "#218B82",  // Sea green
    "#FFD6A5",  // Orange
    "#F9968B",  // Salmon
    "#B1A2CA",  // Purple
    "#E46161",  // Red
  ];

  function pieChart() {
    let browserCount = {}
    for (let i = 0; i < data.length; i++) {
        let browser = getBrowser(data[i].user_agent)
        if (!(browser in browserCount)) {
            browserCount[browser] = 0
        }
        browserCount[browser]++
    }

    let browsers = [];
    let count = [];
    for (let browser in browserCount) {
        browsers.push(browser);
        count.push(browserCount[browser])
    }
    return [{
    values: count,
        labels: browsers,
        type: 'pie',
          marker: {
            colors: colors
        },
    }];
  }

  function browserPlotData() {
    return {
      data: pieChart(),
      layout: browserPlotLayout(),
      config: {
        responsive: true,
        showSendToCloud: false,
        displayModeBar: false,
      },
    };
  }

  function genPlot() {
    let plotData = browserPlotData();
    //@ts-ignore
    new Plotly.newPlot(
      plotDiv,
      plotData.data,
      plotData.layout,
      plotData.config
    );
  }

  let plotDiv: HTMLDivElement;
  onMount(() => {
    genPlot();
  });

  export let data: RequestsData;
</script>

<!-- <div class="card">
  <div class="card-title">Browser</div> -->
  <div id="plotly">
    <div id="plotDiv" bind:this={plotDiv}>
      <!-- Plotly chart will be drawn inside this DIV -->
    </div>
  </div>
<!-- </div> -->

<style>
  .card {
    margin: 2em 0 2em 0;
    padding-bottom: 1em;
    flex: 1;
  }
  #plotDiv {
    margin-right: 20px;
  }
  @media screen and (max-width: 1480px){
    .card {
        margin: 0 0 2em;
        width: 100%;
      }
  }
</style>
